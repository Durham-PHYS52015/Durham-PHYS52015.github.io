<!doctype html><html lang=en dir=ltr>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta name=description content="Sending messages around a ring #  In this exercise we&rsquo;ll write a simple form of global reduction. We will set up the processes in a ring (so each process has a left and right neighbour) and each process should initialise a buffer to its rank.
To compute a global summation a simple method is to rotate each piece of data all the way round the ring: at each step, a process receives from the left and sends to the right.">
<meta name=theme-color content="#FFFFFF"><meta property="og:title" content="MPI: messages round a ring">
<meta property="og:description" content="Sending messages around a ring #  In this exercise we&rsquo;ll write a simple form of global reduction. We will set up the processes in a ring (so each process has a left and right neighbour) and each process should initialise a buffer to its rank.
To compute a global summation a simple method is to rotate each piece of data all the way round the ring: at each step, a process receives from the left and sends to the right.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://durham-phys52015.github.io/exercises/mpi-ring/"><meta property="article:section" content="exercises">
<meta property="article:modified_time" content="2022-03-03T14:52:34+00:00">
<title>MPI: messages round a ring | PHYS52015 – Introduction to HPC</title>
<link rel=manifest href=/manifest.json>
<link rel=icon href=/favicon.png type=image/x-icon>
<link rel=stylesheet href=/book.min.b85762cbec3aa7dfc1fa14ce1d900668d26349753560425c37dac8f9e08407d6.css integrity="sha256-uFdiy+w6p9/B+hTOHZAGaNJjSXU1YEJcN9rI+eCEB9Y=">
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css integrity=sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X crossorigin=anonymous>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js integrity=sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4 crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js integrity=sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa crossorigin=anonymous></script>
<script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}]})})</script>
</head>
<body dir=ltr>
<input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control>
<main class="container flex">
<aside class=book-menu>
<nav>
<div class=book-brand><img class=book-center src=/logo.svg alt=Logo><h2>
<a href=/>
PHYS52015 – Introduction to HPC
</a>
</h2>
</div>
<ul>
<li>
<span>Administrivia</span>
<ul>
<li>
<a href=/setup/remote/>Remote editing/development</a>
</li>
<li>
<a href=/setup/hamilton-quickstart/>Hamilton access & quickstart</a>
</li>
<li>
<a href=/setup/byod/>Local setup</a>
</li>
<li>
<a href=/setup/configuration/>ssh configuration</a>
</li>
<li>
<a href=/setup/unix/>Unix resources</a>
</li>
</ul>
</li>
<li>
<span>Exercises</span>
<ul>
<li>
<a href=/exercises/hello/>Parallel Hello World</a>
</li>
<li>
<a href=/exercises/openmp-loop/>OpenMP: parallel loops</a>
</li>
<li>
<a href=/exercises/openmp-stencil/>OpenMP: stencils</a>
</li>
<li>
<a href=/exercises/openmp-reduction/>OpenMP: synchronisation</a>
</li>
<li>
<a href=/exercises/mpi-ring/ class=active>MPI: messages round a ring</a>
</li>
<li>
<a href=/exercises/mpi-pi/>MPI: Calculating π</a>
</li>
<li>
<a href=/exercises/mpi-ping-pong/>MPI: ping-pong latency</a>
</li>
<li>
<a href=/exercises/mpi-collectives/>MPI: simple collectives</a>
</li>
<li>
<a href=/exercises/mpi-stencil/>MPI: domain decomposition and halo exchanges</a>
</li>
</ul>
</li>
<li>
<a href=/coursework/>Coursework: stencils and collectives</a>
</li>
<li>
<span>Notes</span>
<ul>
<li>
<a href=/notes/introduction/>Introduction and motivation</a>
</li>
<li>
<span>Theory & concepts</span>
<ul>
<li>
<a href=/notes/theory/scaling-laws/>Parallel scaling laws</a>
</li>
<li>
<a href=/notes/theory/hardware-parallelism/>Parallelism in hardware: an overview</a>
</li>
<li>
<a href=/notes/theory/concepts/>Parallel patterns</a>
</li>
</ul>
</li>
<li>
<a href=/notes/openmp/>OpenMP</a>
<ul>
<li>
<a href=/notes/openmp/intro/>What is OpenMP?</a>
</li>
<li>
<a href=/notes/openmp/loop-parallelism/>Loop parallelism</a>
</li>
<li>
<a href=/notes/openmp/collectives/>Collectives</a>
</li>
</ul>
</li>
<li>
<a href=/notes/mpi/>MPI</a>
<ul>
<li>
<a href=/notes/mpi/point-to-point/>Point-to-point messaging in MPI</a>
</li>
<li>
<a href=/notes/mpi/point-to-point-nb/>Non-blocking point-to-point messaging</a>
</li>
<li>
<a href=/notes/mpi/collectives/>Collectives</a>
</li>
<li>
<a href=/notes/mpi/advanced/>Advanced topics</a>
</li>
</ul>
</li>
</ul>
</li>
<li>
<a href=/resources/>Further resources</a>
</li>
<li>
<a href=/acknowledgements/>Acknowledgements</a>
</li>
<li>
<span>Past editions</span>
<ul>
<li>
<span>2020/21</span>
<ul>
<li>
<a href=/past-editions/2020-21/coursework/>Coursework: parallel dense linear algebra</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
<script>(function(){var a=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>
</aside>
<div class=book-page>
<header class=book-header>
<div class="flex align-center justify-between">
<label for=menu-control>
<img src=/svg/menu.svg class=book-icon alt=Menu>
</label>
<strong>MPI: messages round a ring</strong>
<label for=toc-control>
<img src=/svg/toc.svg class=book-icon alt="Table of Contents">
</label>
</div>
<aside class="hidden clearfix">
<nav id=TableOfContents>
<ul>
<li><a href=#code>Code</a></li>
<li><a href=#challenge>Challenge</a></li>
<li><a href=#scaling-study-adding-processes>Scaling study: adding processes</a></li>
</ul>
</nav>
</aside>
</header>
<article class=markdown><h1 id=sending-messages-around-a-ring>
Sending messages around a ring
<a class=anchor href=#sending-messages-around-a-ring>#</a>
</h1>
<p>In this exercise we&rsquo;ll write a simple form of global reduction. We
will set up the processes in a ring (so each process has a left and
right neighbour) and each process should initialise a buffer to its
rank.</p>
<p>To compute a global summation a simple method is to rotate each piece
of data all the way round the ring: at each step, a process receives
from the left and sends to the right.</p>
<p>This is illustrated for five processes in the figure below. The
accumulation happens in the red boxes, and the message at each step is
shown by the arrow between processes.</p>
<figure style=width:75%>
<img class=scaled src=https://durham-phys52015.github.io/images/manual/mpi-ring-reduction.svg alt="Rotating a message around a ring, and accumulating."> <figcaption>
<p>Rotating a message around a ring, and accumulating.</p>
</figcaption>
</figure>
<h2 id=code>
Code
<a class=anchor href=#code>#</a>
</h2>
<p>I provide a template file <a href=https://durham-phys52015.github.io/code/mpi/ring/ring.c><code>ring.c</code></a> in the <code>code/mpi/ring</code> subdirectory of the <a href=https://github.com/Durham-PHYS52015/Durham-PHYS52015.github.io>repository</a>. It initialises and finalises MPI and provides a stub
<code>ring_reduce</code> function which you should implement.</p>
<p>The initial local value is set to the rank. This gives us a nice way
of checking if the summed value is correct, since on $P$ processes,
the final value should be $P(P-1)/2$.</p>
<h2 id=challenge>
Challenge
<a class=anchor href=#challenge>#</a>
</h2>
<blockquote class=exercise>
<h3>Exercise</h3>
<p>Implement the <code>ring_reduce</code> function. If you&rsquo;re already comfortable
with non-blocking messages, you can use those, otherwise, you will
probably find
<a href=https://www.rookiehpc.com/mpi/docs/mpi_sendrecv.php><code>MPI_Sendrecv</code></a>
useful.</p>
<p>Ensure that your function does not modify the value in the <code>sendbuf</code>
argument.</p>
<p>Make sure that your code produces the correct answer, independent of
the number of processes you use.</p>
<p>That is, you should not have to hard-code the total number of
processes anywhere.</p>
</blockquote>
<h2 id=scaling-study-adding-processes>
Scaling study: adding processes
<a class=anchor href=#scaling-study-adding-processes>#</a>
</h2>
<p>Having implemented the reduction, we&rsquo;ll now measure how the
performance varies when we increase the number of processes. First,
think about how many messages your program sends in total as a
function of the total number of processes.</p>
<blockquote class=question>
<h3>Question</h3>
<span>
If each message takes a constant amount of time, what algorithmic
complexity do you expect for your implementation as a function of the
total number of processes $P$?
</span>
</blockquote>
<blockquote class=exercise>
<h3>Exercise</h3>
<p>Time the performance of your reduction from one to 256 processes on
Hamilton. (You&rsquo;ll need to use the batch system for this!)</p>
<p>Produce a plot of the runtime as a function of $P$. Does it tally with
your expectations?</p>
<p>If the total time if <em>very</em> small, you might need to run the reduction
in a loop (say ten times) to get reasonable measurements.</p>
<details>
<summary>Hint</summary>
<div class=markdown-inner>
<p>You can time a section of code with
<a href=https://rookiehpc.com/mpi/docs/mpi_wtime.php><code>MPI_Wtime</code></a></p>
<div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa><code class=language-c data-lang=c><span style=color:#00a8c8>double</span> <span style=color:#111>start</span> <span style=color:#f92672>=</span> <span style=color:#111>MPI_Wtime</span><span style=color:#111>();</span>
<span style=color:#75715e>/* some code here */</span>
<span style=color:#00a8c8>double</span> <span style=color:#111>end</span> <span style=color:#f92672>=</span> <span style=color:#111>MPI_Wtime</span><span style=color:#111>();</span>
<p><span style=color:#00a8c8>double</span> <span style=color:#111>total</span> <span style=color:#f92672>=</span> <span style=color:#111>end</span> <span style=color:#f92672>-</span> <span style=color:#111>start</span><span style=color:#111>;</span>
</code></pre></div></p>
</div>
</details>
</blockquote>
</article>
<footer class=book-footer>
<div class="flex flex-wrap justify-between">
<div><a class="flex align-center" href=https://github.com/Durham-PHYS52015/Durham-PHYS52015.github.io/commit/80e39a5a977842f89b17cfee95787f4886404c7e title="Last modified by Lawrence Mitchell | March 3, 2022" target=_blank rel=noopener>
<img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>March 3, 2022</span>
</a>
</div>
<div>
<a class="flex align-center" href=https://github.com/Durham-PHYS52015/Durham-PHYS52015.github.io/edit/main/site/content/exercises/mpi-ring.md target=_blank rel=noopener>
<img src=/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span>
</a>
</div>
</div>
<div class="flex flex-wrap align-right">
<p>
© 2020&ndash; <a href=mailto:lawrence.mitchell@durham.ac.uk>Lawrence Mitchell</a>, <a href=https://www.ippp.dur.ac.uk/~hschulz/>Holger Schulz</a>, <a href="https://www.dur.ac.uk/physics/staff/profiles/?mode=staff&id=16712">Christian Arnold</a> & <a href=https://www.dur.ac.uk/>Durham University</a>.
</p>
<p>
<a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/>
<img alt="Creative Commons License" style=border-width:0 src=/cc-by-sa.svg>
</a>
This work is licensed under a <a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/>Creative
Commons Attribution-ShareAlike 4.0 International License</a>.
</p>
</div>
</footer>
<label for=menu-control class="hidden book-menu-overlay"></label>
</div>
<aside class=book-toc>
<nav id=TableOfContents>
<ul>
<li><a href=#code>Code</a></li>
<li><a href=#challenge>Challenge</a></li>
<li><a href=#scaling-study-adding-processes>Scaling study: adding processes</a></li>
</ul>
</nav>
</aside>
</main>
</body>
</html>